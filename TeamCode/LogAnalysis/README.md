# Log Analysis Tools

This folder contains Python and PowerShell scripts to analyze robot performance logs (CSV format) generated by the `DataLogger`. These tools help you tune PID controllers and derive Feedforward coefficients mathematically.

## 1. Setup & Installation

### Prerequisites
1.  **Install Python**: Download and install Python 3.x from [python.org](https://www.python.org/downloads/).
    *   *Note: During installation, check the box "Add Python to PATH".*
2.  **Verify Installation**: Open a terminal (PowerShell or Command Prompt) and run:
    ```powershell
    python --version
    ```

### Install Dependencies
Open a terminal in this folder (`TeamCode/LogAnalysis`) and run:
```powershell
pip install -r requirements.txt
```
*If that fails, try:* `python -m pip install -r requirements.txt`

---

## 2. Scripts & Usage

### A. `fetch_logs.ps1`
Downloads CSV log files from the Control Hub to your local computer.

**Prerequisites:**
*   **ADB (Android Debug Bridge)**: Must be installed and in your PATH. This usually comes with Android Studio.

**Usage:**
```powershell
.\fetch_logs.ps1
```
*   Connect your computer to the Control Hub via Wi-Fi or USB.
*   Logs will be saved to the current directory (or `logs/` folder if configured).

for mac, use command line
```shell
adb pull /sdcard/FIRST/data/logs .
```
to pull logs

### B. `clean_logs.ps1`
Deletes all log files from the Control Hub (Internal Storage & SD Card) to free up space.

**Usage:**
```powershell
.\clean_logs.ps1
```
*   **Device Selection:** If multiple devices are connected (e.g., Control Hub via USB and Wi-Fi), the script will list them and ask you to select one.
*   Scans for log directories.
*   Prompts for confirmation before deleting files.
*   Use `.\clean_logs.ps1 -Force` to skip confirmation.

### C. `fetch_system_logs.ps1`
Downloads the Android System Log (`logcat`) from the Control Hub. This is critical for diagnosing **Wi-Fi connection drops**, app crashes, or other system-level issues.

**Usage:**
```powershell
.\fetch_system_logs.ps1
```
*   Saves a text file (e.g., `logcat_20231206_120000.txt`) to the current directory.
*   **What to look for:**
    *   Search for `WifiStateMachine` to see when the robot connects/disconnects.
    *   Search for `wpa_supplicant` for authentication errors.
    *   Search for `Robocol` for FTC network messages.

### D. `analyze_pid.py`
**Purpose:** Visualizes PID performance and analyzes shot consistency. It detects shots automatically and provides detailed metrics on stability and latency.
**Best for:** Tuning shooter consistency and diagnosing mechanical/software delays.

**Usage:**
```powershell
# Analyze a specific file
python analyze_pid.py "path/to/log.csv"

# Analyze the latest log file automatically
python analyze_pid.py

# Save the plot as an image and open it
python analyze_pid.py --save
```

**Key Features:**
*   **Interactive Filtering:** If the log is large, you can select specific shots to analyze in separate windows (e.g., enter `1, 3-5`).
*   **Shot Stability Analysis:**
    *   **Red Index in Console:** Indicates a **Start Diff > 0** (motors were not synced when the shot started).
    *   **Orange Zones on Plot:** Indicates the shot was taken while the motor was **Unstable** (accelerating too fast).
*   **Shot Latency:** Measures the delay between the code command (`IsShooting`) and the actual motor response.
*   **Interactive Tooltip:** Hold **Left Ctrl** and hover over the plot to see exact values.

**Interpreting Results:**
*   **Loop Frequency:** Should be consistent (< 20ms). Spikes > 50ms indicate code lag.
*   **Shot Latency:** High latency (> 300ms) suggests mechanical backlash or loop delays.
*   **Discrepancy (Red Fill):** Large red areas between motor lines mean the left/right motors are fighting each other.

### E. `derive_coefficients.py`
**Purpose:** Performs System Identification (Linear Regression) to mathematically derive the physical Feedforward coefficients (`kS`, `kV`, `kA`) for your motors.
**Best for:** Ramp Tests (slowly accelerating from 0 to max speed) or Quasistatic tests.

**Usage:**
```powershell
# Derive coefficients from a specific file
python derive_coefficients.py "path/to/log.csv"

# Save the plot as an image and open it
python derive_coefficients.py --save
```

**Interpreting Results:**
The script outputs three coefficients:
1.  **kS (Static Friction):** The power required just to break static friction and start moving.
2.  **kV (Velocity Constant):** The power required to maintain a specific velocity (Power per TPS).
3.  **kA (Acceleration Constant):** The power required to accelerate (Power per TPS²).

**R² (Fit Quality):**
*   **Close to 1.0 (e.g., > 0.8):** The model fits the data well. The coefficients are reliable.
*   **Low (e.g., < 0.5):** The data is noisy or doesn't cover enough range (e.g., constant speed only). **Run a "Ramp Test"** (slowly accelerating from 0 to max speed) for better results.

---

## 3. Workflow Example

1.  **Run a Test:** Drive the robot or run a specific mechanism test (e.g., Shooter PID test) to generate a log.
2.  **Fetch Logs:**
    ```powershell
    .\fetch_logs.ps1
    ```
3.  **Analyze PID:** Check if the tuning is good.
    ```powershell
    python analyze_pid.py --save
    ```
4.  **Refine Tuning:**
    *   If you need better Feedforward, run `derive_coefficients.py` on a ramp test log.
    *   Update the constants in your Java code (`Shooter.java` or `DriveConstants.java`).
    *   Repeat.

---

## 4. Wi-Fi & Connection Monitoring

To investigate connection drops, the `WifiMonitor` utility logs signal strength (RSSI) and Link Speed.

**Integrated Logging:**
The `Shooter` subsystem now automatically logs Wi-Fi stats. Every time you run `MainTeleop` or `ShooterTest`, the CSV log will include:
*   `RSSI`: Signal strength in dBm.
*   `LinkSpeed`: Connection speed in Mbps.

**Manual Usage (for other OpModes):**
1.  **Initialize:** `WifiMonitor wifi = new WifiMonitor();`
2.  **Log:** `dataLogger.log(..., wifi.getSignalStrength(), wifi.getLinkSpeed());`

**Analysis:**
*   **RSSI < -80 dBm**: Weak signal. You are entering a dead zone.
*   **Link Speed drops**: Interference or distance issue.

